#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
通过ffprobe拿到视频的宽度, 和比特率, 然后重命名视频文件, 追加信息到`fn.mp4` 为:  `fn-1920x-1000k.mp4`
"""

import os
import subprocess
import sys
from pathlib import Path

def get_video_info(file_path):
    """Get video width and bitrate using ffprobe"""
    cmd = [
        'ffprobe',
        '-v', 'error',
        '-select_streams', 'v:0',
        '-show_entries', 'stream=width,bit_rate',
        '-of', 'default=noprint_wrappers=1:nokey=1',
        file_path
    ]
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    width, bitrate = result.stdout.strip().split('\n')
    return int(width), int(bitrate)

def rename_file(file_path):
    """Rename file with width and bitrate information"""
    width, bitrate = get_video_info(file_path)
    bitrate_k = bitrate // 1000  # Convert to kbps
    
    path = Path(file_path)
    new_name = f"{path.stem}-{width}x-{bitrate_k}k{path.suffix}"
    new_path = path.parent / new_name
    
    os.rename(file_path, new_path)
    print(f"Renamed: {path.name} -> {new_name}")

def main():
    if len(sys.argv) != 2:
        print("Usage: ff-rename <video_file>")
        sys.exit(1)
    
    video_file = sys.argv[1]
    if not os.path.exists(video_file):
        print(f"File not found: {video_file}")
        sys.exit(1)
    
    rename_file(video_file)

if __name__ == "__main__":
    main()
