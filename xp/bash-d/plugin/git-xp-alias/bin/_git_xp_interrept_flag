#!/bin/bash


flags=${1-}

if [ ".$flags" == ".-" ]; then
    flags=""
fi

_out=""
is_flags=1
nr_context=0
use_graph=${GIT_XP_GRAPH:-1}
has_context_specified=${GIT_XP_SHOW_PATCH}
opt_format=${GIT_XP_FORMAT}

fmt_hash='%C(dim yellow)%h%C(reset)'
fmt_time='%C(bold cyan)%ar%C(reset)'
fmt_subject='%C(bold green)%s%C(reset)'
fmt_author='%C(dim magenta)%an%C(reset)'
fmt_ref='%C(dim yellow)%d%C(reset)'
fmt_body='%C(white)%+b%C(reset)'

# format_for_diff="format:'%<(8)$fmt_hash%<(8,trunc)$fmt_author %<(7,trunc)$fmt_time $fmt_subject $fmt_ref%>(1,ltrunc)%b$fmt_body'"
format_for_diff="format:'$fmt_subject - $fmt_author $fmt_time $fmt_hash$fmt_ref%>(1,ltrunc)%b$fmt_body'"

if [ "$opt_format" = "diff" ]; then
    opt_format="$format_for_diff"
fi

for i in $(seq 0 ${#flags}); do
    k=${flags:$i:1}
    case $k in
        a) _out="$_out --all"
            ;;
        b) _out="$_out --simplify-by-decoration"
            ;;
        d) _out="$_out --date-order"
            ;;
        f) _out="$_out --first-parent"
            ;;
        G) use_graph=0
            ;;
        i) _out="$_out --ignore-all-space"
            ;;
        l) opt_format="$format_for_diff"
            ;;
        n) _out="$_out --name-only"
            ;;
        p) _out="$_out --patch"
            has_context_specified=1
            ;;
        r) _out="$_out --relative"
            ;;
        R) _out="$_out --reverse"
            ;;
        s) _out="$_out --max-count "$(expr $(tput lines) / 2)
            ;;
        t) _out="$_out --stat"
            opt_format="${opt_format:-$format_for_diff}"
            ;;
        W) _out="$_out --word-diff=color"
            ;;
        w) _out="$_out --color-words=[[:alpha:]]+|[^[:space:]]"
            ;;

        [0123456789])
            has_context_specified=1
            let nr_context=nr_context*10+k
            ;;

        "")
            ;;
        *)
            is_flags=0
            break
            ;;
    esac

done



if [ "$is_flags" = "1" ]; then

    flags=""

    if [ "$has_context_specified" = "1" ]; then
        if [ "$nr_context" != 0 ]; then
            _out="$_out --unified=$nr_context"
        fi
        opt_format="${opt_format:-$format_for_diff}"
    fi

    if [ "$use_graph" = "1" ]; then
        _out="$_out --graph"
    fi

    opt_format="${opt_format:-oneline}"

    _out="$_out --format=$opt_format"

    echo "$_out"
else
    opt_format="${opt_format:-oneline}"
    echo " --format=$opt_format $flags"
fi
