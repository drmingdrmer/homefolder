#!/bin/bash

# arg | conf
cmd=$1
shift

flags=${1-}

if [ ".$flags" == ".-" ]; then
    flags=""
fi

screen_height=$(expr $(tput lines) - 5)

_out=""
is_flags=1
nr_context=0
flag_use_graph=${GIT_XP_GRAPH:-1}
flag_show_patch=${GIT_XP_SHOW_PATCH}
opt_format=${GIT_XP_FORMAT}
max_lines=${GIT_XP_MAX_LINES-$screen_height}

fmt_hash='%C(dim yellow)%h%C(reset)'
fmt_time='%C(bold cyan)%ar%C(reset)'
fmt_subject='%C(bold green)%s%C(reset)'
fmt_author='%C(dim magenta)%an%C(reset)'
fmt_ref='%C(dim yellow)%d%C(reset)'
fmt_body='%C(white)%+b%C(reset)'

# format_for_diff="format:'%<(8)$fmt_hash%<(8,trunc)$fmt_author %<(7,trunc)$fmt_time $fmt_subject $fmt_ref%>(1,ltrunc)%b$fmt_body'"
format_for_diff="format:'$fmt_subject - $fmt_author $fmt_time $fmt_hash$fmt_ref%>(1,ltrunc)%b$fmt_body'"
format_for_diff="format:'$fmt_hash $fmt_subject - $fmt_author $fmt_time $fmt_ref%>(1,ltrunc)%b$fmt_body'"
format_for_diff="format:'$fmt_hash %C(bold green)%s%C(reset) - $fmt_author $fmt_time %C(bold red)% D%C(reset) %>(1,ltrunc)%b$fmt_body'"

if [ "$opt_format" = "diff" ]; then
    opt_format="$format_for_diff"
fi

for i in $(seq 0 ${#flags}); do
    k=${flags:$i:1}
    case $k in
        a) _out="$_out --all"
            ;;
        b) _out="$_out --simplify-by-decoration"
            ;;
        d) _out="$_out --date-order"
            ;;
        f) _out="$_out --first-parent"
            ;;
        G) flag_use_graph=0
            ;;
        h) max_lines=
            # history: remove max_count limit
            ;;
        i) _out="$_out --ignore-all-space"
            ;;
        l) opt_format="$format_for_diff"
            ;;
        n) _out="$_out --name-only"
            ;;
        p) _out="$_out --patch"
            flag_show_patch=1
            ;;
        r) _out="$_out --relative"
            ;;
        R) _out="$_out --reverse"
            ;;
        t) _out="$_out --stat"
            opt_format="${opt_format:-$format_for_diff}"
            ;;
        W) _out="$_out --word-diff=color"
            ;;
        w) _out="$_out --color-words=[[:alpha:]]+|[^[:space:]]"
            ;;

        [0123456789])
            flag_show_patch=1
            let nr_context=nr_context*10+k
            ;;

        "")
            ;;
        *)
            is_flags=0
            break
            ;;
    esac

done

if [ "$is_flags" = "1" ]; then
    if [ "$flag_show_patch" = "1" ]; then
        max_lines=
    fi
fi


if [ "$cmd" = "conf" ]; then
    if [ "$is_flags" = "1" ]; then
        if [ -n "$max_lines" ]; then
            echo " -c pager.log='head -n $screen_height'"
        fi
    fi
    exit 0
fi


if [ "$is_flags" = "1" ]; then

    flags=""

    if [ "$flag_show_patch" = "1" ]; then
        if [ "$nr_context" != 0 ]; then
            _out="$_out --unified=$nr_context"
        fi
        opt_format="${opt_format:-$format_for_diff}"
    fi

    if [ "$flag_use_graph" = "1" ]; then
        _out="$_out --graph"
    fi

    opt_format="${opt_format:-oneline}"

    _out="$_out --format=$opt_format"

    echo "$_out"
else
    opt_format="${opt_format:-oneline}"
    echo " --format=$opt_format $flags"
fi
