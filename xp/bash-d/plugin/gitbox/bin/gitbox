#!/bin/bash

Brown="$(tput setaf 3)"
Green="$(tput setaf 2)"
Red="$(tput setaf 1)"
NC="$(tput sgr0)" # No Color

hsh() {
    local tip=$1
    git log -n1 --format="%h" $tip
}

fetch_commit_rebase_push() {
    # old git does not add deleted file into index when 'git add .'
    git add .
    git add -u .
    mes="$(git status --short --ignore-submodules --untracked-files=no | head -n1)"
    git commit -m "$mes" > /dev/null

    branch=$(git_head_branch)
    upstream=$(git_branch_default_upstream $branch)

    git fetch origin --quiet \
        && git rebase origin/$upstream --quiet \
        && git push origin $branch --quiet \
        && ok fetch_commit_rebase_push \
        || err fetch_commit_rebase_push

}


log()
{
    echo -e "$(_date) $@${NC} $(get_pwd)"
}

mes()
{
    log "$Brown$@"
}

ok() {
    log "${Green}ok:    $@"
}

err() {
    log "${Red}err:   $@"
}

die() {
    err "$@"
    exit 1
}

_date() {
    date +"%Y-%m-%d %H:%M:%S"
}

get_pwd() {
    local _pwd=$(pwd)
    local p=${1-$_pwd}
    local home=$HOME
    local stripped=${p#$home}
    if [ ".$stripped" == ".$p" ]; then
        :
    else
        stripped="~$stripped"
    fi
    echo -n "$stripped"
}

git_branch_default_upstream_ref()
{
    local branchname=$1
    git config --get branch.${branchname}.merge
}
git_branch_default_upstream()
{
    git_branch_default_upstream_ref "$@" | sed 's/^refs\/heads\///'
}
git_head_branch() {
    git symbolic-ref --short HEAD
}

main() {
    while ``; do
        local conffn="${GITBOX_CONF_FN-$HOME/.gitbox.conf}"
        if [ -f $conffn ]; then
            while read path option; do
                (
                option=${option:-fetch_commit_rebase_push}
                # change ~ to real home path

                eval "p=$path"
                cd "$p" || die not-found: "$p"

                mes "$option"
                branch=$(git_head_branch)

                if [ ".$option" = ".fetchonly" ]; then

                    git fetch --all --quiet \
                        && ok fetch

                elif [ ".$option" = ".fetchpush" ]; then

                    git fetch --all --quiet \
                        && ok fetch \
                        || err fetch

                    git merge --no-edit --commit --ff-only \
                        && ok merge-ff \
                        || err merge-ff

                    git push origin $branch --quiet \
                        && ok push \
                        || err push
                else
                    fetch_commit_rebase_push
                fi
                )
                # ) &
            done <$conffn
            # wait
        else
            echo "no conf file: $conffn"
        fi

        if mac-power is-battery
        then
            echo using battery.. sleep 10 minutes
            sleep 60*10
        else
            sleep 20
        fi
    done
}

main

