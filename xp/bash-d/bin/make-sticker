#!/bin/bash

# usage:
# > make-coding-log.sh x.png title
#
# dependency:
# > brew install imagemagick

fullheight=0
# 0: top
# 0.5: mid
# 1: bottom
text_pos=100

while ``; do
    case $1 in
        -f)
            shift
            fullheight=1
            ;;
        -m)
            shift
            text_pos=50
            ;;
        -p)
            shift
            text_pos=$1
            shift
            ;;
        *)
            break
            ;;
    esac
done


path=$1
text=$2
color=${3-white}

base=${0%/*}

if [ "$fullheight" = '1' ]; then

    convert -define jpeg:size=200 "$path" \
        -thumbnail 400 \
        -gravity center \
        -extent 400 tmp.gif
else
    convert -define jpeg:size=200x200 "$path" \
        -thumbnail 400x400^ \
        -gravity center \
        -extent 400x400 tmp.gif
fi

height=$(identify -ping -format '%h' tmp.gif)


box_height=150
max_width=720

l=${#text}
if [ $l -le 6 ]; then
    fontsize=120
else
    let fontsize=720/l
fi

font=$base/SimHei.ttf

convert -pointsize $fontsize -font "$font" \
    "label:$text"   tt.gif

width=$(identify -ping -format '%w' tt.gif)
if [ "$width" -gt 380 ]; then
    let fontsize=fontsize*380/width
fi
let shadow_offset=3

rm tt.gif

let text_top=height-box_height/2-fontsize/2
let text_top=text_top*text_pos/100
let text_shadow_top=text_top+shadow_offset

output_path="${path%.*}"
output_path="${output_path// /-}"
output_path="$text-${output_path}.gif"

if [ -L "./make-sticker-output" ]; then
    output_path="./make-sticker-output/$output_path"
fi

so=$shadow_offset
t=$text_top

convert tmp.gif \
    -weight 700 \
    -font "$font" \
    -pointsize $fontsize  \
    -weight 1600 \
    -draw "gravity north fill black  text $((so*0)),$((t+so*0)) '$text'" \
    -draw "gravity north fill black  text $((so*1)),$((t+so*0)) '$text'" \
    -draw "gravity north fill black  text $((so*2)),$((t+so*0)) '$text'" \
    -draw "gravity north fill black  text $((so*0)),$((t+so*1)) '$text'" \
    -draw "gravity north fill black  text $((so*2)),$((t+so*1)) '$text'" \
    -draw "gravity north fill black  text $((so*2)),$((t+so*2)) '$text'" \
    -draw "gravity north fill black  text $((so*0)),$((t+so*2)) '$text'" \
    -draw "gravity north fill black  text $((so*1)),$((t+so*2)) '$text'" \
    -draw "gravity north fill black  text $((so*2)),$((t+so*2)) '$text'" \
    -draw "gravity north fill $color text $((so*1)),$((t+so*1)) '$text'" \
    "${output_path}"

rm tmp.gif
